# H∆∞·ªõng d·∫´n t√≠ch h·ª£p MoMo Payment

## üîß Backend API Endpoints

### 1. T·∫°o thanh to√°n MoMo
```
POST /momo/create-payment
```

**Request:**
```json
{
  "amount": 50000,
  "bill_id": "12345",
  "discount_amount": 5000,
  "orderInfo": "Thanh to√°n h√≥a ƒë∆°n #12345",
  "redirectUrl": "http://localhost:3000/payment/momo/return",
  "userInfo": {
    "name": "Nguy·ªÖn VƒÉn A",
    "email": "customer@example.com",
    "phoneNumber": "0123456789"
  }
}
```

**Response:**
```json
{
  "success": true,
  "payUrl": "https://test-payment.momo.vn/...",
  "orderId": "12345_1698765432_5678",
  "billId": "12345",
  "amount": 50000,
  "discountAmount": 5000,
  "message": "T·∫°o thanh to√°n th√†nh c√¥ng"
}
```

**‚ö†Ô∏è L∆∞u √Ω:** `orderId` ƒë∆∞·ª£c t·ª± ƒë·ªông t·∫°o theo format `billId_timestamp_random` ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh duy nh·∫•t cho m·ªói l·∫ßn thanh to√°n, tr√°nh l·ªói "tr√πng orderId" t·ª´ MoMo.

### 2. X·ª≠ l√Ω k·∫øt qu·∫£ tr·∫£ v·ªÅ (handleReturn)
```
GET /momo/return?partnerCode=MOMO&orderId=12345_1698765432_5678&...
```

**Response:**
```json
{
  "success": true,
  "message": "Thanh to√°n th√†nh c√¥ng",
  "orderId": "12345_1698765432_5678",
  "billId": "12345"
}
```

### 3. Ki·ªÉm tra tr·∫°ng th√°i giao d·ªãch
```
POST /momo/query-status
```

**Request:**
```json
{
  "orderId": "12345",
  "lang": "vi"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Truy v·∫•n th√†nh c√¥ng",
  "data": {
    "orderId": "12345",
    "transId": "2234567890",
    "amount": 50000,
    "resultCode": 0,
    "message": "Giao d·ªãch th√†nh c√¥ng",
    "payType": "web",
    "responseTime": 1634567890,
    "paymentOption": "momo",
    "extraData": "",
    "promotionInfo": null,
    "refundTrans": []
  }
}
```

## üöÄ Frontend Integration

### 1. C·∫≠p nh·∫≠t component Checkout

```typescript
// Trong component Checkout.tsx
const handleSubmit = async (values: PaymentFormValues) => {
  if (values.payment_method === 'momo') {
    try {
      setIsProcessingPayment(true);
      
             const paymentData = {
         amount: total,
         bill_id: id,
         discount_amount: discountAmount || 0,
         orderInfo: `Thanh to√°n h√≥a ƒë∆°n #${id}`,
         redirectUrl: `${window.location.origin}/payment/momo/return`,
         userInfo: {
           name: bill.customer_name || 'Kh√°ch h√†ng',
           email: bill.customer_email || '',
           phoneNumber: bill.customer_phone || ''
         }
       };

      const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
      const result = await httpClient(`${API_URL}/momo/create-payment`, {
        method: 'POST',
        body: paymentData
      });

      if (result.success && result.payUrl) {
        message.success('ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn MoMo...');
        // Redirect to MoMo payment page
        window.location.href = result.payUrl;
      } else {
        message.error(result.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o thanh to√°n MoMo');
      }
    } catch (error) {
      console.error('MoMo payment creation failed:', error);
      message.error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn MoMo. Vui l√≤ng th·ª≠ l·∫°i.');
    } finally {
      setIsProcessingPayment(false);
    }
  }
  // ... other payment methods
};
```

### 2. T·∫°o component x·ª≠ l√Ω Return

```typescript
// T·∫°o file MoMoPaymentReturn.tsx
import React, { useEffect, useState } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { Card, Result, Button, Spin, Typography, Alert } from 'antd';
import { CheckCircleOutlined, CloseCircleOutlined } from '@ant-design/icons';
import { httpClient } from '@/utils/http';

const { Title, Text } = Typography;

const MoMoPaymentReturn: React.FC = () => {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const [isProcessing, setIsProcessing] = useState(true);
  const [paymentResult, setPaymentResult] = useState<{
    success: boolean;
    message: string;
    orderId?: string;
    error?: string;
  } | null>(null);

  useEffect(() => {
    const processReturn = async () => {
      try {
        // L·∫•y t·∫•t c·∫£ parameters t·ª´ URL
        const params = {};
        const momoParams = [
          'partnerCode', 'orderId', 'requestId', 'amount', 'orderInfo',
          'orderType', 'transId', 'resultCode', 'message', 'payType',
          'responseTime', 'extraData', 'signature'
        ];

        momoParams.forEach(param => {
          const value = searchParams.get(param);
          if (value) {
            params[param] = value;
          }
        });

        // G·ªçi API handleReturn
        const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
        const response = await httpClient(`${API_URL}/momo/return`, {
          method: 'GET',
          params: params
        });

                 setPaymentResult({
           success: response.success || false,
           message: response.message || 'Kh√¥ng c√≥ th√¥ng tin ph·∫£n h·ªìi',
           orderId: response.orderId || params.orderId,
           billId: response.billId || null,
           error: response.error
         });

      } catch (error) {
        console.error('Error processing MoMo return:', error);
        setPaymentResult({
          success: false,
          message: 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω k·∫øt qu·∫£ thanh to√°n',
          error: error instanceof Error ? error.message : 'Unknown error'
        });
      } finally {
        setIsProcessingPayment(false);
      }
    };

    processReturn();
  }, [searchParams]);

     const handleGoBack = () => {
     if (paymentResult?.billId) {
       navigate(`/admin/bills/${paymentResult.billId}`);
     } else {
       navigate('/admin/bills');
     }
   };

  if (isProcessing) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Card className="w-full max-w-md">
          <div className="text-center">
            <Spin size="large" />
            <Title level={3} className="mt-4">ƒêang x·ª≠ l√Ω k·∫øt qu·∫£ thanh to√°n</Title>
            <Text type="secondary">Vui l√≤ng ch·ªù trong gi√¢y l√°t...</Text>
          </div>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center p-4">
      <Card className="w-full max-w-2xl">
        {paymentResult?.success ? (
          <Result
            status="success"
            title="Thanh to√°n th√†nh c√¥ng!"
            subTitle={
                             <div className="space-y-2">
                 <p>{paymentResult.message}</p>
                 {paymentResult.billId && (
                   <p>
                     <Text strong>M√£ h√≥a ƒë∆°n: </Text>
                     <Text code>#{paymentResult.billId}</Text>
                   </p>
                 )}
                 {paymentResult.orderId && (
                   <p>
                     <Text strong>M√£ giao d·ªãch MoMo: </Text>
                     <Text code>{paymentResult.orderId}</Text>
                   </p>
                 )}
               </div>
            }
            extra={[
              <Button type="primary" key="view-bill" onClick={handleGoBack}>
                Xem h√≥a ƒë∆°n
              </Button>
            ]}
          />
        ) : (
          <Result
            status="error"
            title="Thanh to√°n th·∫•t b·∫°i"
            subTitle={paymentResult?.message || 'Kh√¥ng th·ªÉ x·ª≠ l√Ω thanh to√°n'}
            extra={[
              <Button type="primary" key="back" onClick={handleGoBack}>
                Quay l·∫°i
              </Button>
            ]}
          />
        )}
      </Card>
    </div>
  );
};

export default MoMoPaymentReturn;
```

### 3. Th√™m route trong React Router

```typescript
// Trong file routes/index.tsx
import MoMoPaymentReturn from '@/components/MoMoPaymentReturn';

const routes = [
  // ... existing routes
  {
    path: '/payment/momo/return',
    element: <MoMoPaymentReturn />,
  },
];
```

### 4. Ki·ªÉm tra tr·∫°ng th√°i giao d·ªãch

```typescript
// H√†m ki·ªÉm tra tr·∫°ng th√°i giao d·ªãch
const checkMoMoPaymentStatus = async (orderId: string) => {
  try {
    const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';
    const response = await httpClient(`${API_URL}/momo/query-status`, {
      method: 'POST',
      body: {
        orderId: orderId,
        lang: 'vi'
      }
    });

    if (response.success) {
      console.log('Payment status:', response.data);
      return response.data;
    } else {
      console.error('Query failed:', response.message);
      return null;
    }
  } catch (error) {
    console.error('Error checking payment status:', error);
    return null;
  }
};

// S·ª≠ d·ª•ng trong component
const handleCheckStatus = async () => {
  const status = await checkMoMoPaymentStatus(orderId);
  if (status) {
    if (status.resultCode === 0) {
      message.success('Giao d·ªãch ƒë√£ thanh to√°n th√†nh c√¥ng!');
    } else {
      message.warning(`Tr·∫°ng th√°i: ${status.message}`);
    }
  }
};
```

## üìù Lu·ªìng ho·∫°t ƒë·ªông t·ªïng th·ªÉ

```mermaid
graph TD
    A[User click "Thanh to√°n MoMo"] --> B[Frontend g·ªçi /momo/create-payment]
    B --> C[Backend t·∫°o payment request]
    C --> D[Backend g·ªçi MoMo API]
    D --> E[Nh·∫≠n payUrl t·ª´ MoMo]
    E --> F[Redirect user ƒë·∫øn MoMo]
    F --> G[User thanh to√°n tr√™n MoMo]
    G --> H[MoMo redirect v·ªÅ /momo/return]
    H --> I[Backend x·ª≠ l√Ω handleReturn]
    I --> J[Frontend hi·ªÉn th·ªã k·∫øt qu·∫£]
    
    G --> K[MoMo g·ª≠i IPN ƒë·∫øn /momo/notify]
    K --> L[Backend x·ª≠ l√Ω handleNotify]
    L --> M[C·∫≠p nh·∫≠t database]
    
    J --> N[C√≥ th·ªÉ g·ªçi /momo/query-status]
    N --> O[Ki·ªÉm tra tr·∫°ng th√°i ch√≠nh x√°c]
```

## üéØ C√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng

### 1. T·∫°o thanh to√°n c∆° b·∫£n
```typescript
const paymentData = {
  amount: 50000,
  bill_id: billId,
  discount_amount: 0,
  orderInfo: `Thanh to√°n h√≥a ƒë∆°n #${billId}`
};
```

### 2. Thanh to√°n v·ªõi gi·∫£m gi√° v√† th√¥ng tin kh√°ch h√†ng
```typescript
const paymentData = {
  amount: 50000,
  bill_id: billId,
  discount_amount: 5000,
  orderInfo: `Thanh to√°n h√≥a ƒë∆°n #${billId}`,
  userInfo: {
    name: 'Nguy·ªÖn VƒÉn A',
    email: 'customer@example.com',
    phoneNumber: '0123456789'
  }
};
```

### 3. Thanh to√°n v·ªõi danh s√°ch s·∫£n ph·∫©m v√† gi·∫£m gi√°
```typescript
const paymentData = {
  amount: 50000,
  bill_id: billId,
  discount_amount: 10000,
  orderInfo: `Thanh to√°n h√≥a ƒë∆°n #${billId}`,
  items: [
    {
      name: 'M√≥n ƒÉn 1',
      quantity: 2,
      amount: 25000,
      image: 'https://example.com/image1.jpg'
    },
    {
      name: 'M√≥n ƒÉn 2',
      quantity: 1,
      amount: 25000,
      image: 'https://example.com/image2.jpg'
    }
  ]
};
```

### 4. Thanh to√°n v·ªõi m√£ gi·∫£m gi√° √°p d·ª•ng
```typescript
// V√≠ d·ª•: Bill t·ªïng ti·ªÅn 100.000 VNƒê, gi·∫£m gi√° 15.000 VNƒê
const paymentData = {
  amount: 85000,        // S·ªë ti·ªÅn th·ª±c t·∫ø ph·∫£i thanh to√°n
  bill_id: billId,
  discount_amount: 15000, // S·ªë ti·ªÅn ƒë√£ ƒë∆∞·ª£c gi·∫£m
  orderInfo: `Thanh to√°n h√≥a ƒë∆°n #${billId} (ƒê√£ gi·∫£m 15.000 VNƒê)`,
  userInfo: {
    name: 'Nguy·ªÖn VƒÉn A',
    email: 'customer@example.com',
    phoneNumber: '0123456789'
  }
};
```

### 5. ƒê·ªãnh k·ª≥ ki·ªÉm tra tr·∫°ng th√°i
```typescript
const pollPaymentStatus = async (orderId: string, maxAttempts: number = 5) => {
  for (let i = 0; i < maxAttempts; i++) {
    const status = await checkMoMoPaymentStatus(orderId);
    
    if (status && status.resultCode === 0) {
      return { success: true, data: status };
    }
    
    // ƒê·ª£i 5 gi√¢y tr∆∞·ªõc khi ki·ªÉm tra l·∫°i
    await new Promise(resolve => setTimeout(resolve, 5000));
  }
  
  return { success: false, message: 'Timeout checking payment status' };
};
```

## üîç C√°c m√£ tr·∫°ng th√°i th∆∞·ªùng g·∫∑p

| M√£ | √ù nghƒ©a | H√†nh ƒë·ªông |
|----|---------|-----------| 
| 0 | Giao d·ªãch th√†nh c√¥ng | C·∫≠p nh·∫≠t tr·∫°ng th√°i paid |
| 1001 | Giao d·ªãch ƒëang ch·ªù thanh to√°n | Ti·∫øp t·ª•c polling |
| 1003 | Giao d·ªãch ƒë√£ b·ªã h·ªßy | Hi·ªÉn th·ªã th√¥ng b√°o h·ªßy |
| 1004 | Giao d·ªãch ƒë√£ h·∫øt h·∫°n | T·∫°o giao d·ªãch m·ªõi |
| 2001 | Sai th√¥ng tin | Ki·ªÉm tra l·∫°i data |
| 21 | S·ªë d∆∞ kh√¥ng ƒë·ªß | Th√¥ng b√°o cho user |

## üõ†Ô∏è Debug v√† Testing

### 1. Log c√°c request/response
```typescript
const debugMoMoPayment = (data: any, label: string) => {
  if (process.env.NODE_ENV === 'development') {
    console.log(`[MoMo ${label}]`, data);
  }
};
```

### 2. Test v·ªõi s·ªë ti·ªÅn nh·ªè
```typescript
// Lu√¥n test v·ªõi s·ªë ti·ªÅn >= 1000 VND
const testPayment = {
  amount: 1000, // Minimum amount
  orderId: `test_${Date.now()}`,
  orderInfo: 'Test payment'
};
```

### 3. Ki·ªÉm tra timeout
```typescript
// Set timeout 30s cho query API
const queryWithTimeout = async (orderId: string) => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  
  try {
    const response = await fetch('/momo/query-status', {
      method: 'POST',
      signal: controller.signal,
      body: JSON.stringify({ orderId })
    });
    
    clearTimeout(timeoutId);
    return response;
  } catch (error) {
    if (error.name === 'AbortError') {
      throw new Error('Request timeout');
    }
    throw error;
  }
};
```

## üîÑ X·ª≠ l√Ω l·ªói "Tr√πng orderId"

H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ tr√°nh l·ªói "Y√™u c·∫ßu b·ªã t·ª´ ch·ªëi v√¨ tr√πng orderId":

### Gi·∫£i ph√°p:
- **orderId t·ª± ƒë·ªông**: H·ªá th·ªëng t·ª± t·∫°o orderId theo format `billId_timestamp_random`
- **Tham s·ªë ƒë·∫ßu v√†o**: S·ª≠ dd·ª•ng `bill_id` thay v√¨ `orderId` trong request
- **Response m·ªõi**: Tr·∫£ v·ªÅ c·∫£ `orderId` (c·ªßa MoMo) v√† `billId` (c·ªßa h·ªá th·ªëng)

### Migration t·ª´ phi√™n b·∫£n c≈©:
```typescript
// C≈© ‚ùå
const paymentData = {
  orderId: billId,
  amount: total
};

// M·ªõi ‚úÖ
const paymentData = {
  bill_id: billId, 
  amount: total
};
```

### X·ª≠ l√Ω response:
```typescript
// Response s·∫Ω c√≥ c·∫£ orderId v√† billId
if (result.success) {
  console.log('MoMo orderId:', result.orderId); // "123_1698765432_5678"
  console.log('Bill ID:', result.billId);       // "123"
  window.location.href = result.payUrl;
}
```

## üìã Checklist tri·ªÉn khai

- [ ] ƒê√£ c·∫•u h√¨nh ƒë√∫ng ACCESS_KEY v√† SECRET_KEY
- [ ] ƒê√£ th√™m route cho c√°c endpoint MoMo
- [ ] ƒê√£ t·∫°o component x·ª≠ l√Ω return
- [ ] ƒê√£ test v·ªõi s·ªë ti·ªÅn h·ª£p l·ªá (1000-50000000 VND)
- [ ] ƒê√£ x·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p l·ªói
- [ ] ƒê√£ implement query status cho tracking
- [ ] ƒê√£ test flow ho√†n ch·ªânh
- [ ] ƒê√£ c·∫•u h√¨nh redirect URL ƒë√∫ng
- [ ] ƒê√£ handle timeout cho c√°c API call
- [ ] ‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·ª≠ d·ª•ng `bill_id` thay v√¨ `orderId`
- [ ] ‚úÖ ƒê√£ x·ª≠ l√Ω response v·ªõi c·∫£ `orderId` v√† `billId` 
