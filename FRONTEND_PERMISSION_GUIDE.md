# H∆∞·ªõng d·∫´n Frontend - H·ªá th·ªëng ph√¢n quy·ªÅn

## üéØ T·ªïng quan cho Frontend Developer

### **Nh·ªØng ƒëi·ªÅu Frontend c·∫ßn quan t√¢m:**

## 1. **üîê Authentication & User Info**

### **L·∫•y th√¥ng tin user hi·ªán t·∫°i:**
```javascript
GET /@me
Response: {
  "id": 1,
  "name": "Nguy·ªÖn VƒÉn A",
  "email": "admin@example.com",
  "superadmin": true,
  "roles": [
    {
      "id": 1,
      "name": "Qu·∫£n tr·ªã vi√™n",
      "key": "admin",
      "level": 10,
      "permissions": {
        "user:browse": true,
        "user:create": true,
        "user:update": true,
        "user:delete": true,
        // ... other permissions
      }
    }
  ],
  "permissions": {
    "user:browse": 1,
    "user:create": 1,
    "user:update": 1,
    "user:delete": 1,
    // ... (t·∫•t c·∫£ permissions user c√≥)
  }
}
```

## 2. **üìú L·∫•y danh s√°ch t·∫•t c·∫£ permissions c√≥ th·ªÉ:**
```javascript
GET /permissions
Response: {
  "tree": {
    "default": {
      "children": {
        "user": {
          "description": "Qu·∫£n l√Ω nh√¢n vi√™n",
          "actions": {
            "browse": {"permission": "user:browse", "description": "Browse"},
            "create": {"permission": "user:create", "description": "Create"},
            "update": {"permission": "user:update", "description": "Update"},
            "delete": {"permission": "user:delete", "description": "Delete"}
          }
        },
        "dish": {
          "description": "Qu·∫£n l√Ω m√≥n ƒÉn",
          "actions": {
            "browse": {"permission": "dish:browse", "description": "Browse"},
            "create": {"permission": "dish:create", "description": "Create"}
          }
        }
      }
    }
  },
  "flat": [
    "user:browse",
    "user:create", 
    "user:update",
    "user:delete",
    "dish:browse",
    "dish:create",
    // ... all permissions
  ]
}
```

## 3. **üõ°Ô∏è C√°ch ki·ªÉm tra quy·ªÅn trong Frontend:**

### **A. Ki·ªÉm tra permissions t·ª´ user data:**
```javascript
// Utils function ƒë·ªÉ ki·ªÉm tra quy·ªÅn
const checkPermission = (userPermissions, requiredPermission) => {
  // N·∫øu user l√† superadmin th√¨ c√≥ t·∫•t c·∫£ quy·ªÅn
  if (user.superadmin) return true;
  
  // Ki·ªÉm tra c√≥ permission c·ª• th·ªÉ
  return userPermissions[requiredPermission] === 1;
};

// Ki·ªÉm tra nhi·ªÅu quy·ªÅn (OR - c√≥ √≠t nh·∫•t 1 quy·ªÅn)
const hasAnyPermission = (userPermissions, permissions) => {
  if (user.superadmin) return true;
  return permissions.some(permission => userPermissions[permission] === 1);
};

// Ki·ªÉm tra nhi·ªÅu quy·ªÅn (AND - c√≥ t·∫•t c·∫£ quy·ªÅn)
const hasAllPermissions = (userPermissions, permissions) => {
  if (user.superadmin) return true;
  return permissions.every(permission => userPermissions[permission] === 1);
};

// S·ª≠ d·ª•ng
const canCreateUser = checkPermission(user.permissions, 'user:create');
const canManageUsers = hasAnyPermission(user.permissions, ['user:create', 'user:update', 'user:delete']);
```

### **B. API ƒë·ªÉ ki·ªÉm tra quy·ªÅn realtime:**
```javascript
POST /users/{userId}/check-permission
{
  "permission": "user:create"
}

Response: {
  "success": true,
  "data": {
    "user_id": 1,
    "permission": "user:create", 
    "has_permission": true,
    "is_superadmin": false
  }
}
```

## 4. **üé® Conditional Rendering based on Permissions:**

### **React Example:**
```jsx
import { useState, useEffect } from 'react';

// Custom hook ƒë·ªÉ l·∫•y user permissions
const useAuth = () => {
  const [user, setUser] = useState(null);
  
  useEffect(() => {
    // L·∫•y th√¥ng tin user khi component mount
    fetch('/@me')
      .then(res => res.json())
      .then(userData => setUser(userData));
  }, []);
  
  const checkPermission = (permission) => {
    if (!user) return false;
    if (user.superadmin) return true;
    return user.permissions[permission] === 1;
  };
  
  return { user, checkPermission };
};

// Component v·ªõi conditional rendering
const UserManagement = () => {
  const { user, checkPermission } = useAuth();
  
  if (!user) return <div>Loading...</div>;
  
  return (
    <div>
      <h1>Qu·∫£n l√Ω nh√¢n vi√™n</h1>
      
      {/* Ch·ªâ hi·ªÉn th·ªã n√∫t t·∫°o user n·∫øu c√≥ quy·ªÅn */}
      {checkPermission('user:create') && (
        <button onClick={handleCreateUser}>
          T·∫°o nh√¢n vi√™n m·ªõi
        </button>
      )}
      
      {/* Ch·ªâ hi·ªÉn th·ªã b·∫£ng user n·∫øu c√≥ quy·ªÅn browse */}
      {checkPermission('user:browse') ? (
        <UserTable />
      ) : (
        <div>B·∫°n kh√¥ng c√≥ quy·ªÅn xem danh s√°ch nh√¢n vi√™n</div>
      )}
    </div>
  );
};

// Component UserTable v·ªõi conditional actions
const UserTable = () => {
  const { checkPermission } = useAuth();
  
  return (
    <table>
      <thead>
        <tr>
          <th>T√™n</th>
          <th>Email</th>
          {checkPermission('user:update') && <th>H√†nh ƒë·ªông</th>}
        </tr>
      </thead>
      <tbody>
        {users.map(user => (
          <tr key={user.id}>
            <td>{user.name}</td>
            <td>{user.email}</td>
            {checkPermission('user:update') && (
              <td>
                <button onClick={() => editUser(user.id)}>S·ª≠a</button>
                {checkPermission('user:delete') && (
                  <button onClick={() => deleteUser(user.id)}>X√≥a</button>
                )}
              </td>
            )}
          </tr>
        ))}
      </tbody>
    </table>
  );
};
```

### **Vue.js Example:**
```vue
<template>
  <div>
    <h1>Qu·∫£n l√Ω nh√¢n vi√™n</h1>
    
    <!-- Conditional rendering v·ªõi v-if -->
    <button v-if="canCreate" @click="createUser">
      T·∫°o nh√¢n vi√™n m·ªõi
    </button>
    
    <table v-if="canBrowse">
      <thead>
        <tr>
          <th>T√™n</th>
          <th>Email</th>
          <th v-if="canUpdate">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="user in users" :key="user.id">
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td v-if="canUpdate">
            <button @click="editUser(user.id)">S·ª≠a</button>
            <button v-if="canDelete" @click="deleteUser(user.id)">X√≥a</button>
          </td>
        </tr>
      </tbody>
    </table>
    
    <div v-else>
      B·∫°n kh√¥ng c√≥ quy·ªÅn xem danh s√°ch nh√¢n vi√™n
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'

const user = ref(null)
const users = ref([])

// Computed properties cho permissions
const canBrowse = computed(() => checkPermission('user:browse'))
const canCreate = computed(() => checkPermission('user:create'))
const canUpdate = computed(() => checkPermission('user:update'))
const canDelete = computed(() => checkPermission('user:delete'))

const checkPermission = (permission) => {
  if (!user.value) return false
  if (user.value.superadmin) return true
  return user.value.permissions[permission] === 1
}

onMounted(async () => {
  // L·∫•y th√¥ng tin user
  const response = await fetch('/@me')
  user.value = await response.json()
})
</script>
```

## 5. **üóÇÔ∏è Menu/Navigation Permissions:**

```javascript
// Menu configuration v·ªõi permissions
const menuItems = [
  {
    title: 'Qu·∫£n l√Ω nh√¢n vi√™n',
    path: '/users',
    permission: 'user:browse',
    icon: 'users'
  },
  {
    title: 'Qu·∫£n l√Ω m√≥n ƒÉn', 
    path: '/dishes',
    permission: 'dish:browse',
    icon: 'utensils'
  },
  {
    title: 'Ph√¢n quy·ªÅn',
    path: '/roles',
    permission: 'role:browse', 
    icon: 'shield'
  },
  {
    title: 'C·∫•u h√¨nh',
    path: '/settings',
    permission: 'site-setting:browse',
    icon: 'settings'
  }
];

// Filter menu d·ª±a tr√™n permissions
const getVisibleMenuItems = (userPermissions) => {
  return menuItems.filter(item => {
    if (!item.permission) return true; // Menu public
    return checkPermission(userPermissions, item.permission);
  });
};
```

## 6. **üîÑ API Error Handling:**

```javascript
// Interceptor ƒë·ªÉ handle permission errors
axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 403) {
      // User kh√¥ng c√≥ quy·ªÅn
      showNotification('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y', 'error');
      
      // C√≥ th·ªÉ redirect v·ªÅ trang ch√≠nh ho·∫∑c disable UI
      return Promise.reject(error);
    }
    
    if (error.response?.status === 401) {
      // User ch∆∞a ƒëƒÉng nh·∫≠p
      redirectToLogin();
      return Promise.reject(error);
    }
    
    return Promise.reject(error);
  }
);
```

## 7. **üìã Role Management Interface:**

```javascript
// Component ƒë·ªÉ qu·∫£n l√Ω roles c·ªßa user
const UserRoleManager = ({ userId }) => {
  const [userRoles, setUserRoles] = useState([]);
  const [availableRoles, setAvailableRoles] = useState([]);
  
  // L·∫•y roles hi·ªán t·∫°i c·ªßa user
  const fetchUserRoles = async () => {
    const response = await fetch(`/users/${userId}/roles`);
    const data = await response.json();
    setUserRoles(data.data.roles);
  };
  
  // G√°n roles cho user
  const assignRoles = async (roleIds) => {
    await fetch(`/users/${userId}/roles`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role_ids: roleIds })
    });
    
    await fetchUserRoles(); // Refresh
  };
  
  // Th√™m 1 role
  const addRole = async (roleId) => {
    await fetch(`/users/${userId}/roles/attach`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role_id: roleId })
    });
    
    await fetchUserRoles();
  };
  
  // X√≥a 1 role  
  const removeRole = async (roleId) => {
    await fetch(`/users/${userId}/roles/detach`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role_id: roleId })
    });
    
    await fetchUserRoles();
  };
  
  return (
    <div>
      {/* UI ƒë·ªÉ ch·ªçn v√† g√°n roles */}
    </div>
  );
};
```

## 8. **üéõÔ∏è Permission Matrix Component:**

```javascript
// Component hi·ªÉn th·ªã matrix permissions
const PermissionMatrix = ({ roleId }) => {
  const [permissions, setPermissions] = useState({});
  const [allPermissions, setAllPermissions] = useState({});
  
  const togglePermission = (permission) => {
    setPermissions(prev => ({
      ...prev,
      [permission]: !prev[permission]
    }));
  };
  
  return (
    <div className="permission-matrix">
      {Object.entries(allPermissions.tree.default.children).map(([resource, data]) => (
        <div key={resource} className="permission-group">
          <h3>{data.description}</h3>
          
          {Object.entries(data.actions).map(([action, actionData]) => (
            <label key={actionData.permission} className="permission-item">
              <input
                type="checkbox"
                checked={permissions[actionData.permission] || false}
                onChange={() => togglePermission(actionData.permission)}
              />
              {actionData.description}
            </label>
          ))}
        </div>
      ))}
    </div>
  );
};
```

## **üéØ T√ìM T·∫ÆT - Nh·ªØng ƒëi·ªÅu quan tr·ªçng Frontend c·∫ßn l√†m:**

1. **üîê L·∫•y th√¥ng tin user & permissions** khi login/app start
2. **‚úÖ Ki·ªÉm tra permissions** tr∆∞·ªõc khi hi·ªÉn th·ªã UI elements  
3. **üé® Conditional rendering** cho buttons, menus, pages
4. **üõ°Ô∏è Handle API errors** cho 401/403 responses
5. **üîÑ Real-time permission checks** n·∫øu c·∫ßn thi·∫øt
6. **üìã Role management interface** cho admin
7. **üóÇÔ∏è Dynamic menu/navigation** d·ª±a tr√™n permissions

### **üìä Permission Format c·∫ßn nh·ªõ:**
- Format: `"resource:action"` (VD: `"user:create"`)
- User permissions: `{"permission": 1}` (1 = c√≥ quy·ªÅn)
- Superadmin: `user.superadmin = true` (c√≥ t·∫•t c·∫£ quy·ªÅn) 
